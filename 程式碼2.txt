<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <style>
    /* è¨­å®šæ·±è‰²èƒŒæ™¯ */
    body { background-color: #121212; color: #e0e0e0; font-family: sans-serif; }
    /* å¡ç‰‡æ¨£å¼ */
    .card { background-color: #1e1e1e; border: none; border-radius: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.3); margin-bottom: 15px; }
    .card-title { color: #aaaaaa; font-size: 0.9rem; }
    /* é‡‘é¡é¡è‰² */
    .amount-expense { color: #ff6b6b; font-weight: bold; }
    .amount-income { color: #4ecdc4; font-weight: bold; }
    /* åˆ—è¡¨é …ç›® */
    .list-group-item { background-color: #1e1e1e; border-color: #333; color: #fff; display: flex; justify-content: space-between; align-items: center; padding: 15px; }
    .date-badge { font-size: 0.75rem; color: #888; display: block; }
    .item-name { font-size: 1.1rem; font-weight: 500; }
    /* è®€å–å‹•ç•« */
    #loading { text-align: center; padding: 50px; color: #888; }
  </style>
</head>
<body>

<div class="container py-4" style="max-width: 600px;">
  
  <h4 class="mb-4 fw-bold text-center">ğŸ’° æˆ‘çš„ AI è¨˜å¸³æœ¬</h4>

  <div class="row g-3 mb-4">
    <div class="col-6">
      <div class="card p-3 text-center">
        <div class="card-title">æœ¬æœˆæ”¯å‡º</div>
        <h3 class="amount-expense" id="totalExpense">$0</h3>
      </div>
    </div>
    <div class="col-6">
      <div class="card p-3 text-center">
        <div class="card-title">æœ¬æœˆæ”¶å…¥</div>
        <h3 class="amount-income" id="totalIncome">$0</h3>
      </div>
    </div>
  </div>

  <div class="card p-3 mb-4">
    <h6 class="text-center mb-3 text-muted">æ”¯å‡ºåˆ†é¡ä½”æ¯”</h6>
    <div style="height: 250px; display: flex; justify-content: center;">
      <canvas id="expenseChart"></canvas>
    </div>
  </div>

  <h5 class="mb-3 ps-2 border-start border-4 border-primary">æœ€è¿‘äº¤æ˜“ç´€éŒ„</h5>
  
  <div id="loading">
    <div class="spinner-border text-primary" role="status"></div>
    <div class="mt-2">æ­£åœ¨è®€å–è³‡æ–™...</div>
  </div>

  <div class="list-group" id="transactionList"></div>

</div>

<script>
  // ç•¶ç¶²é è¼‰å…¥å®Œæˆæ™‚ï¼Œå‘¼å«å¾Œç«¯æŠ“è³‡æ–™
  window.onload = function() {
    google.script.run
      .withSuccessHandler(renderPage) // æˆåŠŸæŠ“åˆ°è³‡æ–™å¾Œï¼ŒåŸ·è¡Œ renderPage
      .withFailureHandler(onFail)     // å¤±æ•—æ™‚ï¼ŒåŸ·è¡Œ onFail
      .getDataFromSheet();
  };

  function onFail(error) {
    document.getElementById('loading').innerHTML = '<p class="text-danger">âŒ è®€å–å¤±æ•—ï¼Œè«‹æª¢æŸ¥å¾Œç«¯ç¨‹å¼ç¢¼ã€‚</p>';
    console.error(error);
  }

  // æŠŠæŠ“åˆ°çš„è³‡æ–™ç•«åœ¨ç•«é¢ä¸Š
  function renderPage(data) {
    // 1. éš±è—è®€å–å‹•ç•«
    document.getElementById('loading').style.display = 'none';
    
    const list = document.getElementById('transactionList');
    let totalExp = 0;
    let totalInc = 0;
    const categoryMap = {};

    // 2. è¿´åœˆè™•ç†æ¯ä¸€ç­†è³‡æ–™
    // è³‡æ–™çµæ§‹: [æ—¥æœŸ(0), é¡å‹(1), é …ç›®(2), é‡‘é¡(3), åˆ†é¡(4)]
    data.forEach(row => {
      // é˜²æ­¢ç©ºè¡Œå ±éŒ¯
      if (!row[0]) return;

      const type = row[1];
      // æŠŠé‡‘é¡ "$1,000" é€™ç¨®æ–‡å­—è½‰æˆæ•¸å­—
      const amount = parseInt(String(row[3]).replace(/[^0-9.-]+/g,"")) || 0;
      const category = row[4];
      const date = row[0];
      const item = row[2];

      // è¨ˆç®—ç¸½é¡ & åˆ†é¡çµ±è¨ˆ
      if (type === 'æ”¯å‡º') {
        totalExp += amount;
        if (category) {
          categoryMap[category] = (categoryMap[category] || 0) + amount;
        }
      } else if (type === 'æ”¶å…¥') {
        totalInc += amount;
      }

      // ç”¢ç”Ÿåˆ—è¡¨çš„ HTML
      const itemHTML = `
        <div class="list-group-item">
          <div>
            <span class="date-badge">${date}</span>
            <span class="item-name">${item}</span>
            <span class="badge bg-secondary ms-2" style="font-weight:normal; opacity:0.7">${category}</span>
          </div>
          <div class="${type === 'æ”¯å‡º' ? 'amount-expense' : 'amount-income'}">
            ${type === 'æ”¯å‡º' ? '-' : '+'} $${amount.toLocaleString()}
          </div>
        </div>
      `;
      list.innerHTML += itemHTML;
    });

    // 3. æ›´æ–°ä¸Šæ–¹ç¸½æ•¸å­—
    document.getElementById('totalExpense').innerText = '$' + totalExp.toLocaleString();
    document.getElementById('totalIncome').innerText = '$' + totalInc.toLocaleString();

    // 4. ç•«åœ“é¤…åœ–
    drawChart(categoryMap);
  }

  // ç•«åœ–è¡¨çš„å‡½å¼
  function drawChart(dataMap) {
    const ctx = document.getElementById('expenseChart').getContext('2d');
    
    // å¦‚æœæ²’æœ‰æ”¯å‡ºè³‡æ–™ï¼Œé¡¯ç¤ºæç¤º
    if (Object.keys(dataMap).length === 0) {
       return;
    }

    new Chart(ctx, {
      type: 'doughnut', // ç”œç”œåœˆåœ–
      data: {
        labels: Object.keys(dataMap),
        datasets: [{
          data: Object.values(dataMap),
          backgroundColor: [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'
          ],
          borderWidth: 0
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'bottom', labels: { color: '#aaa', padding: 20 } }
        }
      }
    });
  }
</script>

</body>
</html>